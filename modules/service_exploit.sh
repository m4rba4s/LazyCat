#!/bin/bash
# modules/service_exploit.sh
# Service Exploitation Scanner Module

run_service_exploit() {
    local out_dir="$1"
    
    log_info "Phase 2.2: Service Exploitation Scanner"
    
    mkdir -p "$out_dir/services"
    
    local ip_list="$out_dir/smb/target_ips.txt"
    if [[ ! -s "$ip_list" ]]; then
        log_warn "No IPs found for service scanning"
        return 0
    fi
    
    # 1. Comprehensive Port Scan with Version Detection
    log_info "Running comprehensive port scan..."
    local scan_output="$out_dir/services/nmap_scan.xml"
    
    nmap -sV -sC --version-intensity 5 \
        -p- --open \
        -Pn \
        -oX "$scan_output" \
        -oN "$out_dir/services/nmap_scan.txt" \
        -iL "$ip_list" 2>/dev/null
    
    # 2. Extract Services and Versions
    log_info "Extracting service versions..."
    if command -v xsltproc &>/dev/null && [[ -f "$scan_output" ]]; then
        xsltproc "$scan_output" > "$out_dir/services/nmap_scan.html" 2>/dev/null
    fi
    
    # Parse for vulnerable services
    grep -E "open.*product:" "$out_dir/services/nmap_scan.txt" > "$out_dir/services/detected_services.txt"
    
    # 3. CVE Correlation (using searchsploit if available)
    if command -v searchsploit &>/dev/null; then
        log_info "Correlating CVEs with searchsploit..."
        
        while read -r line; do
            # Extract service name and version
            local service=$(echo "$line" | awk '{print $3}')
            local version=$(echo "$line" | grep -oP 'product: \K[^ ]+' || echo "")
            
            if [[ -n "$service" && -n "$version" ]]; then
                log_info "Searching exploits for $service $version..."
                searchsploit "$service $version" >> "$out_dir/services/exploits.txt" 2>&1
            fi
        done < "$out_dir/services/detected_services.txt"
        
        # Extract critical exploits
        grep -iE "(remote|rce|code execution)" "$out_dir/services/exploits.txt" > \
            "$out_dir/services/critical_exploits.txt" 2>/dev/null
    fi
    
    # 4. Default Credentials Check
    log_info "Checking for default credentials..."
    {
        echo "=== Default Credentials Check ==="
        
        # Redis
        while read -r ip; do
            if nc -zv "$ip" 6379 2>&1 | grep -q "succeeded"; then
                if echo "INFO" | nc -w 2 "$ip" 6379 | grep -q "redis_version"; then
                    echo "[CRITICAL] Redis without authentication on $ip:6379" >> "$out_dir/services/findings.txt"
                fi
            fi
        done < "$ip_list"
        
        # MongoDB
        while read -r ip; do
            if nc -zv "$ip" 27017 2>&1 | grep -q "succeeded"; then
                echo "[HIGH] MongoDB exposed on $ip:27017" >> "$out_dir/services/findings.txt"
            fi
        done < "$ip_list"
        
        # Elasticsearch
        while read -r ip; do
            if curl -s "http://$ip:9200" | grep -q "cluster_name"; then
                echo "[HIGH] Elasticsearch without auth on $ip:9200" >> "$out_dir/services/findings.txt"
            fi
        done < "$ip_list"
        
    } > "$out_dir/services/default_creds.txt"
    
    # 5. Generate Metasploit Module Suggestions
    if [[ -s "$out_dir/services/critical_exploits.txt" ]]; then
        log_info "Generating Metasploit module suggestions..."
        {
            echo "# Metasploit Modules for Detected Services"
            echo "# Generated by LazyCat"
            echo ""
            grep -oP 'exploit/[^ ]+' "$out_dir/services/critical_exploits.txt" | \
                awk '{print "use " $0 "\nset RHOSTS <target>\nrun\n"}'
        } > "$out_dir/services/msf_modules.rc"
    fi
    
    # Summary
    # Summary
    local findings_count=0
    if [[ -f "$out_dir/services/findings.txt" ]]; then
        findings_count=$(wc -l < "$out_dir/services/findings.txt")
    fi
    local exploits_count=0
    if [[ -f "$out_dir/services/critical_exploits.txt" ]]; then
        exploits_count=$(wc -l < "$out_dir/services/critical_exploits.txt")
    fi
    
    log_info "Service Scan Complete:"
    log_info "  - Findings: $findings_count"
    log_info "  - Potential Exploits: $exploits_count"
    
    if [[ "$findings_count" -gt 0 ]]; then
        log_warn "⚠️  Critical service vulnerabilities detected!"
    fi
}
